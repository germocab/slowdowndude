<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calma</title>
    <style>
        :root {
            --bg: #f4f7f6;
            --circle: #a7c4c2;
            --text: #3e5151;
            --btn-bg: #ffffff;
            --panic-color: #e6b3b3;
            --font-serif: 'Georgia', serif;
            --font-sans: 'Helvetica Neue', Arial, sans-serif;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121b22;
                --circle: #2d4547;
                --text: #d5e1e1;
                --btn-bg: #1c2a33;
                --panic-color: #4a3434;
            }
        }

        body.light-mode { --bg: #f4f7f6; --circle: #a7c4c2; --text: #3e5151; --btn-bg: #ffffff; --panic-color: #e6b3b3; }
        body.dark-mode { --bg: #121b22; --circle: #2d4547; --text: #d5e1e1; --btn-bg: #1c2a33; --panic-color: #4a3434; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-serif);
            height: 100vh; width: 100vw;
            overflow: hidden;
            transition: background 0.8s, color 0.8s;
            font-size: 1.2rem; /* Aumento general de Serif */
        }

        /* Navegación */
        .slider-container { display: flex; width: 200vw; height: 100vh; transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        .page { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 20px; }

        .pagination-dots {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 15px; z-index: 1000;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--text); opacity: 0.2; cursor: pointer; border: none; }
        .dot.active { opacity: 0.9; transform: scale(1.2); }

        /* Pantallas Fullscreen (Ajustes / Evaluación) */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 2000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }

        h2 { font-size: 2rem; font-style: italic; margin-bottom: 30px; font-weight: normal; }

        .setting-row { width: 100%; max-width: 320px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .control-group { display: flex; align-items: center; gap: 20px; }
        .step-btn { 
            width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--circle); 
            background: var(--btn-bg); color: var(--text); font-size: 1.5rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .val-display { font-family: var(--font-sans); font-weight: 800; font-size: 1.5rem; min-width: 30px; }

        /* Respiración */
        .circle {
            width: 200px; height: 200px; background-color: var(--circle);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin: 40px 0;
            transition: transform 1s ease-in-out;
        }
        #timer { font-family: var(--font-sans); font-weight: 700; font-size: 4.5rem; color: white; }
        #status { font-size: 2.2rem; font-style: italic; min-height: 2.5rem; margin-bottom: 10px; }
        
        .action-btn {
            padding: 20px 60px; border: none; background: var(--btn-bg);
            color: var(--text); border-radius: 50px; font-family: var(--font-serif);
            font-size: 1.3rem; font-weight: bold; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        /* Pánico */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        .panic-btn {
            width: 240px; height: 240px; background-color: var(--panic-color);
            border-radius: 50%; border: none; color: var(--text);
            font-family: var(--font-serif); font-style: italic; font-size: 1.8rem;
            cursor: pointer; z-index: 100; transition: all 0.4s ease;
        }
        .panic-active { transform: scale(1.15); background-color: var(--circle); color: white; }
    </style>
</head>
<body>

    <div class="pagination-dots">
        <button class="dot active" onclick="changePage(0)" id="dot1"></button>
        <button class="dot" onclick="changePage(1)" id="dot2"></button>
    </div>

    <div id="settings-screen" class="fullscreen-overlay">
        <h2>Configuración</h2>
        <button class="action-btn" onclick="toggleThemeManual()" style="margin-bottom: 40px; font-size: 1rem; padding: 10px 30px;">Cambiar Modo Visual</button>
        
        <div class="setting-row">
            <span>Inhalar</span>
            <div class="control-group">
                <button class="step-btn" onclick="changeVal('in', -1)">-</button>
                <span id="in-val" class="val-display">4</span>
                <button class="step-btn" onclick="changeVal('in', 1)">+</button>
            </div>
        </div>
        <div class="setting-row">
            <span>Mantener</span>
            <div class="control-group">
                <button class="step-btn" onclick="changeVal('hold', -1)">-</button>
                <span id="hold-val" class="val-display">2</span>
                <button class="step-btn" onclick="changeVal('hold', 1)">+</button>
            </div>
        </div>
        <div class="setting-row">
            <span>Exhalar</span>
            <div class="control-group">
                <button class="step-btn" onclick="changeVal('out', -1)">-</button>
                <span id="out-val" class="val-display">4</span>
                <button class="step-btn" onclick="changeVal('out', 1)">+</button>
            </div>
        </div>
        <button class="action-btn" onclick="closeSettings()" style="margin-top:20px;">Guardar</button>
    </div>

    <div id="eval-screen" class="fullscreen-overlay">
        <h2>¿Cómo estás ahora?</h2>
        <button class="action-btn" onclick="finishSession()">Estoy mejor</button>
        <button class="action-btn" style="background:transparent; border:1px solid var(--circle); margin-top:20px;" onclick="continueSession()">Sigo mal</button>
    </div>

    <div class="slider-container" id="slider">
        <section class="page">
            <button id="settBtn" onclick="openSettings()" style="position:absolute; top:30px; right:30px; background:none; border:1px solid var(--text); border-radius:20px; padding:8px 20px; color:var(--text); cursor:pointer; opacity:0.6;">Ajustes</button>
            <p id="status">Paz</p>
            <div class="circle" id="breathCircle"><span id="timer">0</span></div>
            <div id="cycles-count" style="margin-bottom:20px; opacity:0.5;">Ciclos: 0</div>
            <button class="action-btn" id="actionBtn" onclick="handleAction()">Comenzar</button>
        </section>

        <section class="page">
            <canvas id="panicCanvas"></canvas>
            <h2 style="opacity:0.4; margin-bottom:50px;">Sostén para calmar</h2>
            <button class="panic-btn" id="panicBtn" onmousedown="startPanic()" onmouseup="stopPanic()" ontouchstart="startPanic()" ontouchend="stopPanic()">Sosténme</button>
        </section>
    </div>

    <script>
        let isActive = false, cycles = 0, times = { in: 4, hold: 2, out: 4 }, currentPage = 0, startX = 0;

        // --- NAVEGACIÓN ---
        function changePage(index) {
            currentPage = index;
            document.getElementById('slider').style.transform = `translateX(-${index * 100}vw)`;
            document.getElementById('dot1').classList.toggle('active', index === 0);
            document.getElementById('dot2').classList.toggle('active', index === 1);
        }
        window.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        window.addEventListener('touchend', e => {
            let diff = startX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) changePage(diff > 0 ? 1 : 0);
        });

        // --- AJUSTES ---
        function openSettings() { if(!isActive) document.getElementById('settings-screen').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-screen').style.display = 'none'; }
        function changeVal(t, d) { times[t] = Math.max(t === 'hold' ? 0 : 1, times[t] + d); document.getElementById(`${t}-val`).innerText = times[t]; }
        function toggleThemeManual() { document.body.classList.toggle('dark-mode'); }

        // --- RESPIRACIÓN ---
        function vibrate(p) { if("vibrate" in navigator) navigator.vibrate(p); }
        function runTimer(s) {
            let c = s; document.getElementById('timer').innerText = c;
            const t = setInterval(() => { c--; if(c >= 0) document.getElementById('timer').innerText = c; else clearInterval(t); }, 1000);
        }

        async function cycle() {
            if(!isActive) return;
            const c = document.getElementById('breathCircle'), s = document.getElementById('status');
            s.innerText = "Inhala..."; vibrate(50);
            c.style.transition = `transform ${times.in}s ease-in-out`; c.style.transform = "scale(1.8)";
            runTimer(times.in); await new Promise(r => setTimeout(r, times.in * 1000));
            if(!isActive) return;

            s.innerText = "Mantén..."; vibrate([40, 60, 40]);
            runTimer(times.hold); await new Promise(r => setTimeout(r, times.hold * 1000));
            if(!isActive) return;

            s.innerText = "Exhala..."; vibrate(150);
            c.style.transition = `transform ${times.out}s ease-in-out`; c.style.transform = "scale(1)";
            runTimer(times.out); await new Promise(r => setTimeout(r, times.out * 1000));

            if(isActive) {
                cycles++; document.getElementById('cycles-count').innerText = `Ciclos: ${cycles}`;
                if(cycles % 10 === 0) showEval(); else cycle();
            }
        }

        function handleAction() {
            isActive = !isActive;
            const btn = document.getElementById('actionBtn');
            if(isActive) { btn.innerText = "Detener"; document.getElementById('settBtn').style.visibility = 'hidden'; cycle(); }
            else { resetSession(); }
        }

        function resetSession() {
            isActive = false; cycles = 0;
            document.getElementById('actionBtn').innerText = "Comenzar";
            document.getElementById('cycles-count').innerText = "Ciclos: 0";
            document.getElementById('status').innerText = "Paz";
            document.getElementById('timer').innerText = "0";
            document.getElementById('breathCircle').style.transform = "scale(1)";
            document.getElementById('settBtn').style.visibility = 'visible';
            let id = window.setTimeout(() => {}, 0); while (id--) window.clearTimeout(id);
        }

        function showEval() { isActive = false; document.getElementById('eval-screen').style.display = 'flex'; }
        function continueSession() { document.getElementById('eval-screen').style.display = 'none'; isActive = true; cycle(); }
        function finishSession() { document.getElementById('eval-screen').style.display = 'none'; resetSession(); }

        // --- CANVAS PÁNICO ---
        const canvas = document.getElementById('panicCanvas');
        const ctx = canvas.getContext('2d');
        let circles = [], animReq, panicking = false;
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        function startPanic() {
            panicking = true; canvas.style.opacity = '1'; vibrate([50, 50, 50]);
            document.getElementById('panicBtn').classList.add('panic-active');
            animate();
        }
        function stopPanic() {
            panicking = false; canvas.style.opacity = '0';
            document.getElementById('panicBtn').classList.remove('panic-active');
            cancelAnimationFrame(animReq); circles = [];
        }
        function animate() {
            if(!panicking) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(Math.random() > 0.85) circles.push({ r: 0, o: 0.6 });
            circles.forEach((c, i) => {
                c.r += 4; c.o -= 0.007;
                ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, c.r, 0, Math.PI*2);
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--circle');
                ctx.globalAlpha = c.o; ctx.lineWidth = 3; ctx.stroke();
                if(c.o <= 0) circles.splice(i, 1);
            });
            animReq = requestAnimationFrame(animate);
        }
    </script>
</body>
</html>
